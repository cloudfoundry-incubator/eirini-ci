spruce:
- base: $PROJECT_ROOT/pipelines/modules/kube-cluster.yml
  prune:
  - meta
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-pr/with-diego.yml
  to: {{cluster-with-diego}}

- base: $PROJECT_ROOT/pipelines/modules/deploy-eirini.yml
  prune:
  - meta
  modify:
    delete:
      - "jobs.name:deploy-scf-eirini-eirini-pr.plan.get:eirini-release.trigger"
      - "jobs.name:deploy-scf-uaa-eirini-pr.plan.task:deploy-uaa.input_mapping"
      - "jobs.name:deploy-scf-uaa-eirini-pr.plan.get:scf-uaa-resources.trigger"
    set:
      - path: jobs.name:deploy-scf-eirini-pr.plan.task:deploy-scf.file
        value: ci-resources/tasks/deploy-scf/task-with-image-override.yml
      - path: jobs.name:deploy-scf-uaa-eirini-pr.plan.get:scf-uaa-resources.get
        value: eirini-release
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/modules/deploy-with-image-tag.yml
      - $PROJECT_ROOT/pipelines/eirini-pr/with-diego.yml
      - $PROJECT_ROOT/notifications/pull-requests/hook.yml
      - $PROJECT_ROOT/notifications/slack/deploy-eirini.yml
  to: {{eirini-with-diego}}

- base: $PROJECT_ROOT/pipelines/modules/run-core-cats.yml
  prune:
  - meta
  - skipped_cats
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/modules/cats-with-eirini-trigger.yml
      - $PROJECT_ROOT/pipelines/eirini-pr/with-diego.yml
      - $PROJECT_ROOT/pipelines/modules/diego-skipped-cats.yml
      - $PROJECT_ROOT/notifications/pull-requests/hook.yml
      - $PROJECT_ROOT/notifications/slack/run-core-cats.yml
  to: {{cats-with-diego}}

- base: $PROJECT_ROOT/pipelines/modules/test-and-build-docker-images.yml
  modify:
    delete:
      - "resources.name:eirini"
      - "resources.name:eirini-opi-init"
      - "resources.name:eirini-secret-smuggler"
      - "resources.name:eirini-fluentd"
      - "jobs.name:create-opi-init-docker-image.plan.task:make-docker-build-args.input_mapping"
      - "jobs.name:create-secret-smuggler-docker-image.plan.task:make-docker-build-args.input_mapping"
      - "jobs.name:run-fluentd-unit-tests.plan.task:run-unit-tests.input_mapping"
      - "jobs.name:create-fluentd-docker-image.plan.task:make-docker-build-args.input_mapping"
      # Disable auto trigger
      - "jobs.name:run-tests.plan.0.in_parallel.get:cluster-eirini-pr-staging-event-ready"
      - "jobs.name:run-tests.plan.0.in_parallel.get:sample-configs.trigger"
    set:
      # Build opi-init image from PR, after the tests pass
      - path: jobs.name:create-opi-init-docker-image.plan.0.in_parallel.get:eirini-opi-init.get
        value: eirini
      - path: jobs.name:create-opi-init-docker-image.plan.0.in_parallel.get:eirini.passed.+
        value: clean-up-environment
      - path: jobs.name:create-opi-init-docker-image.plan.put:docker-opi-init.params.build
        value: eirini/docker/opi/init
      - path: jobs.name:run-tests.plan.0.in_parallel.get:eirini.passed.+
        value: clean-up-environment

      # Build secret-smuggler image from PR, after the tests pass
      - path: jobs.name:create-secret-smuggler-docker-image.plan.0.in_parallel.get:eirini-secret-smuggler.get
        value: eirini
      - path: jobs.name:create-secret-smuggler-docker-image.plan.0.in_parallel.get:eirini.passed.+
        value: clean-up-environment
      - path: jobs.name:create-secret-smuggler-docker-image.plan.put:docker-secret-smuggler.params.build
        value: eirini/docker/registry/certs/smuggler

      # Build secret-smuggler image from PR, after the tests pass
      - path: jobs.name:run-fluentd-unit-tests.plan.0.in_parallel.get:eirini-fluentd.get
        value: eirini
      - path: jobs.name:run-fluentd-unit-tests.plan.0.in_parallel.get:eirini.passed.+
        value: clean-up-environment
      - path: jobs.name:create-fluentd-docker-image.plan.get:eirini-fluentd.get
        value: eirini
      - path: jobs.name:create-fluentd-docker-image.plan.put:docker-fluentd.params.build
        value: eirini/fluentd

  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-pr/with-diego.yml
      - $PROJECT_ROOT/notifications/pull-requests/hook.yml
      - $PROJECT_ROOT/notifications/slack/test-and-build-docker-images.yml
  to: {{test-and-build-docker}}

- base: $PROJECT_ROOT/pipelines/modules/empty.yml
  merge:
  - with:
      files:
      - {{cluster-with-diego}}
      - {{test-and-build-docker}}
      - {{eirini-with-diego}}
      - {{cats-with-diego}}
      - $PROJECT_ROOT/pipelines/modules/clean-up-pr-environment.yml
      - $PROJECT_ROOT/pipelines/eirini-pr/pr-success.yml
      - $PROJECT_ROOT/pipelines/modules/tag-images.yml
  modify:
    delete:
      - "resources.name:scf-uaa-resources"
    set:
        # We do not have to delete UAA in this pipeline, thus only nuke SCF
      - path: jobs.name:clean-up-environment.plan.task:clean-up-environment.file
        value: ci-resources/tasks/nuke-scf/task.yml
  to: $PIPELINE_YML
