# With-Diego
spruce:
- base: $PROJECT_ROOT/pipelines/modules/kube-cluster.yml
  prune:
  - meta
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/with-diego.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/kube-cluster.yml
  to: {{cluster-with-diego}}

- base: $PROJECT_ROOT/pipelines/modules/deploy-eirini.yml
  prune:
  - meta
  - cloud-specific
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/modules/lock.yml
      - $PROJECT_ROOT/pipelines/eirini-release/with-diego.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/deploy-eirini.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-deployment.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/iks.yml
  to: {{eirini-with-diego}}

# With-OPI
- base: $PROJECT_ROOT/pipelines/modules/kube-cluster.yml
  prune:
  - meta
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/with-opi.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/kube-cluster.yml
  to: {{cluster-with-opi}}

- base: $PROJECT_ROOT/pipelines/modules/deploy-eirini.yml
  prune:
  - meta
  - cloud-specific
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/modules/lock.yml
      - $PROJECT_ROOT/pipelines/eirini-release/with-opi.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/deploy-eirini.yml
      - $PROJECT_ROOT/pipelines/modules/verify-no-diego.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-deployment.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/iks.yml
  to: {{eirini-with-opi}}

# Freshini
- base: $PROJECT_ROOT/pipelines/modules/kube-cluster.yml
  prune:
  - meta
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/freshini.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/kube-cluster.yml
  to: {{cluster-freshini}}

- base: $PROJECT_ROOT/pipelines/modules/deploy-eirini.yml
  prune:
  - meta
  - cloud-specific
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/modules/lock.yml
      - $PROJECT_ROOT/pipelines/eirini-release/freshini.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/deploy-eirini.yml
      - $PROJECT_ROOT/pipelines/modules/verify-no-diego.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-deployment.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/iks.yml
  modify:
    set:
     - path: jobs.name:deploy-scf-uaa-freshini.plan.task:waiting-for-uaa.attempts
       value: 50
     - path: jobs.name:deploy-scf-eirini-freshini.plan.task:smoke-eirini.attempts
       value: 80
  to: {{eirini-freshini}}

# GKE
- base: $PROJECT_ROOT/pipelines/modules/gcp-kube-cluster.yml
  prune:
  - meta
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/gke.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/kube-cluster.yml
  to: {{cluster-gkerini}}

- base: $PROJECT_ROOT/pipelines/modules/deploy-eirini.yml
  prune:
  - meta
  - cloud-specific
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/modules/lock.yml
      - $PROJECT_ROOT/pipelines/eirini-release/gke.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/deploy-eirini.yml
      - $PROJECT_ROOT/pipelines/modules/verify-no-diego.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-deployment.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/gke.yml
  modify:
    delete:
    - jobs.name:deploy-scf-eirini-gkerini.plan.task:block-network-access
  to: {{eirini-gkerini}}

# With-Diego CATs
- base: $PROJECT_ROOT/pipelines/modules/run-core-cats.yml
  prune:
  - meta
  - skipped_cats
  - cloud-specific
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/with-diego.yml
      - $PROJECT_ROOT/pipelines/modules/diego-skipped-cats.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/run-core-cats.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-cats.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/iks.yml
  modify:
    set:
     - path: jobs.name:run-core-cats-with-diego.plan.task:run cats.params.INCLUDE_DOCKER
       value: true
  to: {{cats-with-diego}}

# With-OPI CATs
- base: $PROJECT_ROOT/pipelines/modules/run-core-cats.yml
  prune:
  - meta
  - skipped_cats
  - cloud-specific
  go_patch: true
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/with-opi.yml
      - $PROJECT_ROOT/pipelines/modules/opi-skipped-cats.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/run-core-cats.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-cats.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/iks.yml
  to: {{cats-with-opi}}

# Freshini CATs
- base: $PROJECT_ROOT/pipelines/modules/run-core-cats.yml
  prune:
  - meta
  - skipped_cats
  - cloud-specific
  go_patch: true
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/freshini.yml
      - $PROJECT_ROOT/pipelines/modules/opi-skipped-cats.yml
      - $PROJECT_ROOT/pipelines/modules/nuke-cf.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/run-core-cats.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-cats.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/iks.yml
  to: {{cats-freshini}}

# GKE
- base: $PROJECT_ROOT/pipelines/modules/run-core-cats.yml
  prune:
  - meta
  - skipped_cats
  - cloud-specific
  go_patch: true
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/eirini-release/gke.yml
      - $PROJECT_ROOT/pipelines/modules/gke-opi-skipped-cats.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/run-core-cats.yml
      - $PROJECT_ROOT/pipelines/eirini-release/pass-lock-through-cats.yml
      - $PROJECT_ROOT/pipelines/modules/cloud-specific/gke.yml
  to: {{cats-gkerini}}


# Fast Forward
- base: $PROJECT_ROOT/pipelines/modules/ff-master.yml
  merge:
  - with:
      files:
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/ff-master.yml
  to: {{ff-master}}

# Helm lint
- base: $PROJECT_ROOT/pipelines/modules/helm-lint.yml
  prune:
  - meta
  to: {{helm-lint}}

# Bring it on!
- base: $PROJECT_ROOT/pipelines/modules/empty.yml
  merge:
  - with:
      files:
      - {{cluster-with-diego}}
      - {{cluster-with-opi}}
      - {{cluster-freshini}}
      - {{cluster-gkerini}}
      - {{eirini-with-diego}}
      - {{eirini-with-opi}}
      - {{eirini-freshini}}
      - {{eirini-gkerini}}
      - {{cats-with-diego}}
      - {{cats-with-opi}}
      - {{cats-freshini}}
      - {{cats-gkerini}}
      - {{helm-lint}}
      - {{ff-master}}
  to: $PIPELINE_YML

