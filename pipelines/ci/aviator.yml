spruce:
- base: $PROJECT_ROOT/pipelines/modules/kube-cluster.yml
  prune:
  - meta
  modify:
    delete:
    - "jobs.name:prepare-cluster-((world-name))"
    - "resources.name:cluster-((world-name))-staging-event-ready"
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/dev/meta.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/kube-cluster.yml
  to: {{create-cluster}}

- base: $PROJECT_ROOT/pipelines/modules/test-and-build-docker-images.yml
  modify:
    set:
    - path: jobs.name:run-tests.plan.0.in_parallel.get:cluster-((world-name))-staging-event-ready.get
      value: cluster-((world-name))-staging-event-created
    - path: jobs.name:run-tests.plan.0.in_parallel.get:cluster-((world-name))-staging-event-created.passed.0
      value: create-cluster-((world-name))
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/dev/meta.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/test-and-build-docker-images.yml
  to: {{test-and-build-docker}}

- base: $PROJECT_ROOT/pipelines/modules/update-image-version-files.yml
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/dev/meta.yml
      - $PROJECT_ROOT/notifications/slack/hook.yml
      - $PROJECT_ROOT/notifications/slack/update-image-version-files.yml
  to: {{update-image-version-files}}

- base: $PROJECT_ROOT/pipelines/modules/empty.yml
  modify:
    delete:
    - "groups.name:all.jobs.:prepare-cluster-((world-name))"
    - "groups.name:cluster-((world-name)).jobs.:prepare-cluster-((world-name))"
  merge:
  - with:
      files:
      - {{create-cluster}}
      - {{test-and-build-docker}}
      - {{update-image-version-files}}
  to: $PIPELINE_YML
