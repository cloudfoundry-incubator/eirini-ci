spruce:
- base: $PROJECT_ROOT/pipelines/modules/deploy-eirini.yml
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/acceptance/with-diego.yml
  to: {{eirini-with-diego}}

- base: $PROJECT_ROOT/pipelines/modules/run-core-cats.yml
  prune:
  - cats_conf
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/acceptance/cats-conf.yml
      - $PROJECT_ROOT/pipelines/acceptance/with-diego.yml
  to: {{cats-with-diego}}

- base: $PROJECT_ROOT/pipelines/modules/test-and-build-docker-images.yml
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/acceptance/with-diego.yml
  modify:
    delete:
      - "jobs.name:run-tests"
      - "jobs.name:create-docker-images.plan.0.aggregate.get:eirini-release.passed.0"
      - "resources.name:sample-configs"
      - "groups.1.jobs.:run-tests"
      - "groups.2.jobs.:run-tests"
  to: {{test-and-build-docker}}

- base: $PROJECT_ROOT/pipelines/modules/deploy-eirini.yml
  prune:
  - meta
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/acceptance/with-opi.yml
  to: {{eirini-with-opi}}

- base: $PROJECT_ROOT/pipelines/modules/run-core-cats.yml
  prune:
  - meta
  - cats_conf
  go_patch: true
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/acceptance/cats-conf.yml
      - $PROJECT_ROOT/pipelines/acceptance/with-opi.yml
      - $PROJECT_ROOT/pipelines/modules/skip-opi-cats.yml
  to: {{cats-with-opi}}

- base: $PROJECT_ROOT/pipelines/acceptance/publish-release.yml
  merge:
  - with:
      files:
      - $PROJECT_ROOT/pipelines/acceptance/with-diego.yml
  to: {{publish-release}}

- base: $PROJECT_ROOT/pipelines/modules/empty.yml
  prune:
  - meta
  merge:
  - with:
      files:
      - {{test-and-build-docker}}
      - {{eirini-with-diego}}
      - {{eirini-with-opi}}
      - {{cats-with-diego}}
      - {{cats-with-opi}}
      - {{publish-release}}
  modify:
    delete:
      - "jobs.name:run-tests.plan.0.aggregate.get:cluster-acceptance-staging-event-ready.passed"
      - "jobs.name:deploy-scf-uaa-acceptance.plan.get:cluster-acceptance-staging-event-ready.passed"
      - "jobs.name:deploy-scf-uaa-cf-sans-diego.plan.get:cluster-cf-sans-diego-staging-event-ready.passed"
  to: $PIPELINE_YML
