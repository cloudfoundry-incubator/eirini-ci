#!/bin/bash

set -euo pipefail

if [ "${1:-x}" == "help" ]; then
  cat <<EOF
  Usage:

        $ ./set-pipeline <CONCOURSE_TARGET> <PRIVATE_REPO>
EOF
  exit 0
fi

script_dir="$(cd "$(dirname "$0")" && pwd)"
private_repo=$(cd "$script_dir/../../../eirini-private-config" && pwd)
target="${1:-eirini}"

fly -t "${target}" \
  set-pipeline \
  -p ci-images \
  -c <(dhall-fly <<<"$script_dir/pipeline.dhall") \
  -v docker_hub_user=eiriniuser \
  -v docker_hub_password="$(pass eirini/docker-hub)" \
  --load-vars-from "$private_repo/concourse/common.yml"
