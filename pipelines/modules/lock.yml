groups:
- (( defer merge ))
- name: all
  jobs:
  - (( append ))
  - (( concat "lock-" meta.cluster-name ))
  - (( concat "unlock-" meta.cluster-name ))
- (( append ))
- name: release-locks
  jobs:
  - (( append ))
  - (( concat "release-lock-" meta.cluster-name ))

jobs:
- name: (( concat "release-lock-" meta.cluster-name ))
  plan:
  - get: (( concat "lock-" meta.cluster-name ))
  - put: (( concat "lock-" meta.cluster-name ))
    params:
      release: (( concat "lock-" meta.cluster-name ))

- name: (( concat "lock-" meta.cluster-name ))
  plan:
  - get: eirini-release
    trigger: true
  - put: (( concat "lock-" meta.cluster-name ))
    params: {acquire: true}

- name: (( concat "unlock-" meta.cluster-name ))
  plan:
  - get: eirini-release
    trigger: true
    passed:
    - (( grab meta.unlock-passed ))
  - get: (( concat "lock-" meta.cluster-name ))
    trigger: true
    passed:
    - (( grab meta.unlock-passed ))
  - put: (( concat "lock-" meta.cluster-name ))
    params:
      release: (( concat "lock-" meta.cluster-name ))
- name: (( concat "deploy-scf-eirini-" meta.cluster-name ))
  plan:
  - get: eirini-release
    passed:
    - (( concat "lock-" meta.cluster-name ))

resources:
- (( append ))
- name: (( concat "lock-" meta.cluster-name ))
  type: pool
  source:
    uri: git@github.com:cloudfoundry/eirini-private-config.git
    branch: ci-locks
    pool: (( grab meta.cluster-name ))
    private_key: ((github-private-key))
