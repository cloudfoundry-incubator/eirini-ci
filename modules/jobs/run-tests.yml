jobs:
- name: run-tests
  public: true
  plan:
  - in_parallel:
      steps:
      - get: cluster-ci-staging-event-created
        passed:
        - create-cluster-ci
        trigger: true
      - get: eirini
        trigger: true
      - get: eirini-release
      - get: golang-lint
        params:
          skip_download: true
        trigger: true
      - get: ci-resources
  - in_parallel:
      steps:
      - task: run-unit-tests
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: eirini/ci
          inputs:
          - name: eirini
          run:
            path: /usr/bin/env
            args:
            - bash
            - -c
            - (( file "../../inline-tasks/run-unit-tests.sh" ))
      - task: run-static-checks
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: golangci/golangci-lint
              tag: latest
          inputs:
          - name: eirini
          run:
            path: /usr/bin/env
            args:
            - bash
            - -c
            - (( file "../../inline-tasks/run-static-checks.sh" ))
      - do:
        - task: download-kubeconfig
          config:
              platform: linux
              image_resource:
                type: docker-image
                source:
                  repository: eirini/ibmcloud
              inputs:
              - name:  ci-resources
              outputs:
              - name:  kube
              params:
                CLUSTER_NAME: ((world-name))
                IBMCLOUD_ACCOUNT: ((ibmcloud-account))
                IBMCLOUD_PASSWORD: ((ibmcloud-password))
                IBMCLOUD_USER: ((ibmcloud-user))
              run:
                path: /usr/bin/env
                args:
                - bash
                - -c
                - (( file "../../inline-tasks/download-kubeconfig.sh" ))

  on_failure: (( grab slack-notification.on_failure ))
